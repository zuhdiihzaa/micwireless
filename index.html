<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mic Monitor BT</title>
<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f0f14;
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
.container{
    width:90%;
    max-width:420px;
    text-align:center;
}
button{
    width:100%;
    padding:18px;
    font-size:20px;
    border:none;
    border-radius:12px;
    margin-top:15px;
}
#start{background:#00c853;}
#stop{background:#d50000;}
select,input{
    width:100%;
    margin-top:15px;
}
.status{
    margin-top:12px;
    font-size:14px;
}
</style>
</head>
<body>

<div class="container">
    <h2>ðŸŽ¤ Mic â†’ Bluetooth</h2>

    <select id="outputSelect"></select>

    <button id="start">START MIC</button>
    <button id="stop" disabled>STOP MIC</button>

    <input type="range" min="0" max="3" step="0.1" value="1" id="gain">

    <div class="status" id="status">Mic Off</div>
</div>

<script>
let audioContext, source, gainNode, stream;
let audioElement = new Audio();
audioElement.autoplay = true;

async function loadOutputs(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const outputs = devices.filter(d => d.kind === "audiooutput");
    const select = document.getElementById("outputSelect");
    select.innerHTML = "";

    outputs.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.deviceId;
        opt.text = d.label || "Bluetooth / Speaker";
        select.appendChild(opt);
    });
}

document.getElementById("start").onclick = async ()=>{
    stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:true,
            noiseSuppression:true,
            autoGainControl:false
        }
    });

    audioContext = new AudioContext();
    source = audioContext.createMediaStreamSource(stream);
    gainNode = audioContext.createGain();
    gainNode.gain.value = document.getElementById("gain").value;

    const dest = audioContext.createMediaStreamDestination();
    source.connect(gainNode);
    gainNode.connect(dest);

    audioElement.srcObject = dest.stream;

    const deviceId = document.getElementById("outputSelect").value;
    if (audioElement.setSinkId) {
        await audioElement.setSinkId(deviceId);
    }

    document.getElementById("status").innerText = "Mic ON â†’ Bluetooth";
    document.getElementById("start").disabled = true;
    document.getElementById("stop").disabled = false;
};

document.getElementById("stop").onclick = ()=>{
    stream.getTracks().forEach(t=>t.stop());
    audioContext.close();
    document.getElementById("status").innerText = "Mic Off";
    document.getElementById("start").disabled = false;
    document.getElementById("stop").disabled = true;
};

document.getElementById("gain").oninput = e=>{
    if(gainNode) gainNode.gain.value = e.target.value;
};

loadOutputs();
</script>

</body>
</html>
